# Pattern CSS/JS Splitting - Implementation Status

**Last Updated:** 2025-10-09
**Current Phase:** Planning Complete - Ready for Phase 1
**Overall Progress:** 0% (Planning: 100%, Implementation: 0%)

---

## Current Status

### Phase Summary
- ✅ **Planning Phase**: Complete (PATTERN-SPLITTING-PLAN.md created)
- ⏳ **Phase 1**: Webpack Configuration Updates (Not Started)
- ⏳ **Phase 2**: Webpack Pattern Manifest Plugin (Not Started)
- ⏳ **Phase 3**: PHP Pattern Loader (Not Started)
- ⏳ **Phase 4**: Cache Integration (Not Started)
- ⏳ **Phase 5**: Testing & Validation (Not Started)

### Next Steps
1. Begin Phase 1: Update webpack configuration to extract pattern-specific CSS/JS
2. Test pattern extraction with sample patterns
3. Verify protons remain in dream.css bundle

---

## Phase 1: Webpack Configuration Updates

**Status:** Not Started
**Estimated Duration:** 2-3 hours
**Dependencies:** None

### Tasks
- [ ] Update `webpack/webpack.common.js` SplitChunks configuration
  - [ ] Add `patterns-css` cache group for pattern CSS extraction
  - [ ] Add `patterns-js` cache group for pattern JS extraction
  - [ ] Configure test regex to match pattern paths
  - [ ] Set appropriate chunk names and priorities
  - [ ] Exclude demo styles from WordPress bundles
- [ ] Verify protons exclusion (must stay in dream.css)
  - [ ] Test that 00-protons stays in main bundle
  - [ ] Verify variables/mixins globally available
  - [ ] Confirm no breaking changes to existing styles
- [ ] Update `.gitignore` for new pattern chunks
  - [ ] Add `public/wp-content/themes/timberland/dist/patterns-css/`
  - [ ] Add `public/wp-content/themes/timberland/dist/patterns-js/`
- [ ] Test webpack build
  - [ ] Run `npm run build`
  - [ ] Verify pattern chunks created in dist/
  - [ ] Check chunk sizes and structure
  - [ ] Confirm no build errors

### Files to Modify
- `webpack/webpack.common.js` (SplitChunks configuration)
- `.gitignore` (pattern chunk directories)

### Success Criteria
- ✅ Webpack builds without errors
- ✅ Pattern CSS chunks created in `dist/patterns-css/`
- ✅ Pattern JS chunks created in `dist/patterns-js/`
- ✅ Protons remain in `dream.css`
- ✅ Variables/mixins globally available
- ✅ Demo styles excluded from WordPress bundles

---

## Phase 2: Webpack Pattern Manifest Plugin

**Status:** Not Started
**Estimated Duration:** 4-6 hours
**Dependencies:** Phase 1 complete

### Tasks
- [ ] Create `webpack-plugins/PatternManifestPlugin.js`
  - [ ] Implement plugin class structure
  - [ ] Add Twig template scanning (`{% include %}`, `{% embed %}`, `{% extends %}`)
  - [ ] Add PHP Timber scanning (`Timber::render()`, `Timber::compile()`, etc.)
  - [ ] Build dependency graph for nested patterns
  - [ ] Generate pattern manifest JSON
  - [ ] Handle edge cases and errors
- [ ] Configure plugin in webpack
  - [ ] Add to `webpack/webpack.common.js` plugins array
  - [ ] Set output path for manifest
  - [ ] Configure pattern directories to scan
- [ ] Test manifest generation
  - [ ] Run webpack build
  - [ ] Verify `pattern-manifest.json` created
  - [ ] Validate manifest structure and accuracy
  - [ ] Test with nested pattern dependencies

### Pattern Directories to Scan
- `src/patternlab/source/_patterns/01-atoms/`
- `src/patternlab/source/_patterns/02-molecules/`
- `src/patternlab/source/_patterns/03-organisms/`
- `src/patternlab/source/_patterns/04-templates/`
- `src/patternlab/source/_patterns/05-pages/`

### Detection Patterns

#### Twig Templates
```twig
{% include '@atoms/button/_button.tpl.twig' %}
{% embed '@molecules/card/_card.tpl.twig' %}
{% extends '@templates/page/_page.tpl.twig' %}
```

#### PHP Files
```php
Timber::render('button.twig', $context);
Timber::compile('card.twig', $data);
Timber::fetch('hero.twig');
Timber::compile_string($template, $context);
```

### Files to Create
- `webpack-plugins/PatternManifestPlugin.js` (new plugin)
- `dist/pattern-manifest.json` (generated by plugin)

### Files to Modify
- `webpack/webpack.common.js` (add plugin)

### Success Criteria
- ✅ `PatternManifestPlugin.js` created and functional
- ✅ Plugin integrated into webpack build
- ✅ `pattern-manifest.json` generated on build
- ✅ Manifest accurately maps pattern dependencies
- ✅ Nested patterns correctly detected
- ✅ Both Twig and PHP dependencies captured

---

## Phase 3: PHP Pattern Loader

**Status:** Not Started
**Estimated Duration:** 6-8 hours
**Dependencies:** Phase 2 complete

### Tasks
- [ ] Create `src/functions/performance/pattern-loader.php`
  - [ ] Implement manifest loading and caching
  - [ ] Create pattern detection in rendered content
  - [ ] Build dependency resolution system
  - [ ] Implement conditional asset enqueuing
  - [ ] Add error handling and logging
- [ ] Create manual enqueue function
  - [ ] Implement `enqueue_pattern($pattern_name)`
  - [ ] Add Twig function wrapper
  - [ ] Handle dependencies automatically
  - [ ] Validate pattern exists
- [ ] Integrate with WordPress
  - [ ] Register enqueue hooks
  - [ ] Set proper asset priorities
  - [ ] Handle admin vs frontend contexts
- [ ] Add Timber integration
  - [ ] Hook into Timber render cycle
  - [ ] Detect patterns in Timber templates
  - [ ] Support Timber::render, compile, fetch, etc.
- [ ] Test pattern loading
  - [ ] Verify automatic detection works
  - [ ] Test manual enqueue function
  - [ ] Validate dependency loading
  - [ ] Check performance impact

### Manual Enqueue Usage

#### PHP
```php
// Manual enqueue in PHP
enqueue_pattern('card');
enqueue_pattern('button');
```

#### Twig
```twig
{# Manual enqueue in Twig templates #}
{{ function('enqueue_pattern', 'card') }}
{{ function('enqueue_pattern', 'button') }}
```

### Files to Create
- `src/functions/performance/pattern-loader.php` (new loader)

### Files to Modify
- `functions.php` (require pattern-loader.php)
- `src/functions/twig.php` (add Twig function if needed)

### Success Criteria
- ✅ `pattern-loader.php` created and functional
- ✅ Pattern detection works automatically
- ✅ Manual enqueue function works in PHP and Twig
- ✅ Dependencies loaded correctly
- ✅ Assets enqueued with proper priorities
- ✅ No duplicate asset loading
- ✅ Performance acceptable (< 50ms overhead)

---

## Phase 4: Cache Integration

**Status:** Not Started
**Estimated Duration:** 2-3 hours
**Dependencies:** Phase 3 complete

### Tasks
- [ ] Update cache invalidation
  - [ ] Add pattern manifest to cache keys
  - [ ] Invalidate on webpack rebuild
  - [ ] Handle development vs production
- [ ] Test cache behavior
  - [ ] Verify caching works
  - [ ] Test invalidation triggers
  - [ ] Validate cache performance
- [ ] Add cache warming if needed
  - [ ] Pre-load common patterns
  - [ ] Optimize first-page-load

### Files to Modify
- `src/functions/performance/cache.php` (if exists)
- `src/functions/performance/pattern-loader.php` (cache implementation)

### Success Criteria
- ✅ Pattern manifest properly cached
- ✅ Cache invalidates on webpack rebuild
- ✅ Cache improves performance (measurable reduction in load time)
- ✅ No stale cache issues

---

## Phase 5: Testing & Validation

**Status:** Not Started
**Estimated Duration:** 4-6 hours
**Dependencies:** Phases 1-4 complete

### Tasks
- [ ] Test common patterns
  - [ ] Test atoms (button, input, link, etc.)
  - [ ] Test molecules (card, form-field, menu-item, etc.)
  - [ ] Test organisms (header, footer, hero, etc.)
  - [ ] Test templates (page templates)
- [ ] Test nested dependencies
  - [ ] Verify all dependencies load
  - [ ] Check for duplicate loading
  - [ ] Validate load order
- [ ] Test manual enqueue
  - [ ] PHP context
  - [ ] Twig context
  - [ ] Edge cases
- [ ] Performance testing
  - [ ] Measure before/after metrics
  - [ ] Test on multiple pages
  - [ ] Validate bundle sizes
- [ ] Browser testing
  - [ ] Chrome
  - [ ] Firefox
  - [ ] Safari
  - [ ] Edge
- [ ] Update documentation
  - [ ] Document new workflow
  - [ ] Add examples
  - [ ] Update PERFORMANCE-OPTIMIZATION-GUIDE.md

### Test Pages
- Homepage (complex with multiple patterns)
- Single post/page (typical content)
- Archive page (list patterns)
- 404 page (minimal patterns)

### Success Criteria
- ✅ All patterns load correctly
- ✅ Nested dependencies work
- ✅ Manual enqueue functions properly
- ✅ No console errors
- ✅ No visual regressions
- ✅ Performance improved (measurable)
- ✅ All browsers tested successfully
- ✅ Documentation updated

---

## Performance Metrics

### Target Metrics (After Implementation)
- **Page Load Time**: Reduce by 20-30%
- **CSS Bundle Size**: Reduce by 40-60% (only load needed patterns)
- **JS Bundle Size**: Reduce by 30-50% (only load needed patterns)
- **First Contentful Paint**: Improve by 15-25%
- **Time to Interactive**: Improve by 20-30%

### Baseline Metrics (Before Implementation)
*To be measured before starting implementation*

- **Homepage Load Time**: [TBD]
- **Homepage CSS Size**: [TBD]
- **Homepage JS Size**: [TBD]
- **Single Page Load Time**: [TBD]
- **Single Page CSS Size**: [TBD]
- **Single Page JS Size**: [TBD]

### Actual Metrics (After Implementation)
*To be measured after completion*

- **Homepage Load Time**: [TBD]
- **Homepage CSS Size**: [TBD]
- **Homepage JS Size**: [TBD]
- **Single Page Load Time**: [TBD]
- **Single Page CSS Size**: [TBD]
- **Single Page JS Size**: [TBD]

---

## Files Summary

### New Files to Create
1. `webpack-plugins/PatternManifestPlugin.js` - Webpack plugin for pattern manifest generation
2. `src/functions/performance/pattern-loader.php` - PHP loader for conditional pattern assets
3. `dist/pattern-manifest.json` - Generated manifest mapping patterns to assets (git-ignored)
4. `dist/patterns-css/*.css` - Generated pattern CSS chunks (git-ignored)
5. `dist/patterns-js/*.js` - Generated pattern JS chunks (git-ignored)

### Existing Files to Modify
1. `webpack/webpack.common.js` - Add SplitChunks config and PatternManifestPlugin
2. `.gitignore` - Add pattern chunk directories
3. `functions.php` - Require pattern-loader.php
4. `src/functions/twig.php` - Add Twig function for manual enqueue (if needed)
5. `PERFORMANCE-OPTIMIZATION-GUIDE.md` - Update with pattern splitting documentation

### Reference Files (Existing - Do Not Modify)
1. `webpack-plugins/BootstrapManifestPlugin.js` - Reference for plugin structure
2. `src/functions/performance/bootstrap-loader.php` - Reference for loader structure
3. `BOOTSTRAP-SPLITTING-PLAN.md` - Reference implementation approach

---

## Issues & Resolutions

### Issue Log
*Issues will be logged here as they arise during implementation*

**Format:**
```
[Date] - [Phase] - [Issue Title]
Description: [Detailed description]
Resolution: [How it was resolved]
Status: [Open/Resolved/Deferred]
```

---

## Testing Results

### Phase 1 Testing
*Results will be recorded here*

### Phase 2 Testing
*Results will be recorded here*

### Phase 3 Testing
*Results will be recorded here*

### Phase 4 Testing
*Results will be recorded here*

### Phase 5 Testing
*Results will be recorded here*

---

## Critical Requirements (DO NOT FORGET)

### Protons Handling (EXTREMELY IMPORTANT)
- ⚠️ **CRITICAL**: Protons (00-protons) MUST stay in dream.css
- ⚠️ **CRITICAL**: Variables and mixins MUST be globally available
- ⚠️ **CRITICAL**: No breaking changes to existing proton functionality
- Pattern extraction should ONLY affect: atoms, molecules, organisms, templates, pages

### Demo Styles
- ⚠️ **IMPORTANT**: Demo styles (_demo.scss) should ONLY be included in PatternLab
- Demo styles MUST be excluded from WordPress bundles
- Webpack configuration must handle this exclusion

### Separation of Concerns
- ⚠️ **IMPORTANT**: Pattern system separate from Bootstrap system
- PatternManifestPlugin.js ≠ BootstrapManifestPlugin.js
- pattern-loader.php ≠ bootstrap-loader.php
- No mixing of Bootstrap and Pattern logic

### Dependency Detection
- Must scan Twig templates for: `{% include %}`, `{% embed %}`, `{% extends %}`
- Must scan PHP files for: `Timber::render()`, `Timber::compile()`, `Timber::fetch()`, `Timber::compile_string()`
- Must auto-detect nested pattern dependencies
- Must handle circular dependencies gracefully

---

## Context Preservation

### Key Architecture Decisions
1. **Separate from Bootstrap**: Pattern system is completely separate from Bootstrap splitting
2. **Scope**: Only atoms, molecules, organisms, templates, pages (NOT protons)
3. **Protons**: MUST stay in dream.css, variables globally available
4. **Demo Styles**: Excluded from WordPress, PatternLab only
5. **Detection**: Twig templates + PHP Timber methods
6. **Naming**: Follow Bootstrap manifest pattern (pattern-name → assets)
7. **Manual Enqueue**: `enqueue_pattern()` in PHP, `{{ function('enqueue_pattern', 'name') }}` in Twig

### Reference Documents
- `PATTERN-SPLITTING-PLAN.md` - Complete implementation plan
- `BOOTSTRAP-SPLITTING-PLAN.md` - Reference implementation approach
- `PERFORMANCE-OPTIMIZATION-GUIDE.md` - Overall optimization strategy
- `IMPLEMENTATION-STATUS.md` - Bootstrap implementation reference

### Prompts for AI Assistance

#### Starting Implementation
```
I'm implementing Phase [X] of the Pattern CSS/JS Splitting optimization for a WordPress theme using Timber and PatternLab.

Please read these files for context:
1. PATTERN-SPLITTING-PLAN.md (complete plan)
2. PATTERN-IMPLEMENTATION-STATUS.md (current progress)
3. [Phase-specific reference files]

Current Phase: [Phase Name]
Task: [Specific task from checklist]

CRITICAL REQUIREMENTS:
- Protons MUST stay in dream.css
- Variables/mixins MUST be globally available
- Pattern system separate from Bootstrap system
- Demo styles excluded from WordPress

Please help me implement [specific task].
```

#### Troubleshooting Issues
```
I'm experiencing an issue during Phase [X] of Pattern CSS/JS Splitting:

Issue: [Describe the problem]
Expected: [What should happen]
Actual: [What is happening]

Please read:
1. PATTERN-SPLITTING-PLAN.md
2. PATTERN-IMPLEMENTATION-STATUS.md
3. [Relevant code files]

Help me diagnose and resolve this issue.
```

#### Resuming After Break
```
I'm resuming work on Pattern CSS/JS Splitting implementation.

Please read:
1. PATTERN-IMPLEMENTATION-STATUS.md (check "Current Status" section)
2. PATTERN-SPLITTING-PLAN.md (full context)

Last completed: [Last completed task]
Current phase: [Current phase]
Next task: [Next task to work on]

Please help me continue from where I left off.
```

---

## Rollback Plan

### Rollback Points

#### Rollback Point 1: After Phase 1
**Trigger:** Webpack configuration breaks existing build
**Action:**
1. Revert `webpack/webpack.common.js` changes
2. Revert `.gitignore` changes
3. Run `npm run build` to verify
4. Document issue in "Issues & Resolutions"

#### Rollback Point 2: After Phase 2
**Trigger:** Pattern manifest plugin causes build failures
**Action:**
1. Remove `PatternManifestPlugin.js`
2. Remove plugin from `webpack/webpack.common.js`
3. Revert to Rollback Point 1 if needed
4. Run `npm run build` to verify
5. Document issue in "Issues & Resolutions"

#### Rollback Point 3: After Phase 3
**Trigger:** Pattern loader breaks WordPress functionality
**Action:**
1. Remove `require` from `functions.php`
2. Delete `src/functions/performance/pattern-loader.php`
3. Clear WordPress caches
4. Test WordPress functionality
5. Document issue in "Issues & Resolutions"

#### Complete Rollback
**Trigger:** Implementation fundamentally flawed or causing critical issues
**Action:**
1. Revert all webpack changes
2. Remove all new files (plugin, loader, manifests)
3. Clear all caches (WordPress, object cache, browser)
4. Run full build: `npm run build`
5. Test thoroughly on development site
6. Document lessons learned
7. Re-evaluate approach before attempting again

### Git Strategy
- Create feature branch: `feature/pattern-splitting`
- Commit after each phase completion
- Tag rollback points: `pattern-split-phase-X-complete`
- Keep main/master branch stable
- Only merge when all phases complete and tested

---

## Notes & Decisions

### Design Decisions
*Key decisions made during implementation will be logged here*

### Performance Observations
*Performance notes and observations will be logged here*

### Future Enhancements
*Ideas for future improvements will be logged here*

---

## Sign-off

### Phase 1 Sign-off
- [ ] All tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Performance acceptable
- Date: ___________
- By: ___________

### Phase 2 Sign-off
- [ ] All tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Manifest accuracy verified
- Date: ___________
- By: ___________

### Phase 3 Sign-off
- [ ] All tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Loader functionality verified
- Date: ___________
- By: ___________

### Phase 4 Sign-off
- [ ] All tasks completed
- [ ] Tests passing
- [ ] Code reviewed
- [ ] Cache performance verified
- Date: ___________
- By: ___________

### Phase 5 Sign-off
- [ ] All tasks completed
- [ ] All tests passing
- [ ] Cross-browser tested
- [ ] Performance targets met
- [ ] Documentation updated
- Date: ___________
- By: ___________

### Final Project Sign-off
- [ ] All phases complete
- [ ] All tests passing
- [ ] Performance targets met
- [ ] Documentation complete
- [ ] Ready for production
- Date: ___________
- By: ___________

---

**End of Status Document**
